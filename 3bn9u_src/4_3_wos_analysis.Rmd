---
title: '''In the Line of Fire'': *Science* news survey results (COVID-19 researchers)'
author: "Cathleen O'Grady and Tim Errington"
date: "25 March 2022"
output:
  html_document: default
  pdf_document: default
  word_document: default
---

```{r setup, include = FALSE}
# sets global defaults: code and results don't appear in file;
# results, but not code, appear in the file (echo - change this in some chunks)
# messages generated by code don't appear in file; 
# warnings generated by code don't appear in file
knitr::opts_chunk$set(
  include = FALSE,
	echo = FALSE,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
```

```{r preamble}

##### Environment
#####
# platform       x86_64-apple-darwin17.0     
# arch           x86_64                      
# os             darwin17.0                  
# system         x86_64, darwin17.0          
# status                                     
# major          4                           
# minor          1.2                         
# year           2021                        
# month          11                          
# day            01                          
# svn rev        81115                       
# language       R                           
# version.string R version 4.1.2 (2021-11-01)
# nickname       Bird Hippie 
#####

library(tidyverse) #tidyverse_1.3.1
library(janitor) #janitor_2.1.0
library(htmlwidgets) #htmlwidgets_1.5.4
library(data.table) #data.table_1.14.2
library(ggpubr) #ggpubr_0.4.0
library(DescTools) #DescTools_0.99.44
library(knitr) #knitr_1.36

##### Notes on naming shorthands:
#####
# c_[question_name] = column indices for multi-column question
# o_[question_name] = multiple choice options for multi-column question
# s_[question_name] = summary dataset
# p_[question_name] = plot

# all harassment questions involve four sub-questions:
# harassment question 1 (hq1): did you experience this kind of harassment?
# hq2: if yes, through what venues? (multiple columns)
# hq3: if yes, for how long?
# hq4: if yes, how many times / what has the frequency been?
#####
```

``` {r functions and data import}
##### Functions
#####
#function to calculate percentage
pct <- function(num, denom){
  p <- num / denom * 100
  return(p)
}

# returns a list of columns that match a text string
# inputs: dataset and text string
# outputs: a list of column indices, and a printout of column names
column_chunk <- function(dataset, text_string) {
  questionIDs <- grep(text_string, names(dataset))
  # print relevant column names to check whether last item is a free text field
  print(names(dataset[questionIDs]))
  return(questionIDs)
}

# returns multiple choice items from multi-column question
# two list options in a df: one_in_snake_case,
# the other formatted for readability and plots
# inputs: dataset, question prefix (first part of variable name for all columns),
# list of column indices
# returns df with two lists of multiple choice names
get_multiple_choice <- function(dataset, question_prefix,
                                column_indices) {
  column_names <- names(dataset[column_indices])
  pattern <- str_c(".", "*", question_prefix, sep = "")
  mclist <- c()
  for (i in column_names) {
    word <- sub(pattern, "", i)
    mclist <- c(mclist, word)
  }
  f_mclist <- str_to_sentence(
    str_replace_all(
      mclist, c("_" = " ")))
  mc_options <- data.frame(mclist, f_mclist)
  #print(mc_options)
  return (mc_options)
}

# summarises a free-text response column
# copies to new vector, drops NAs, writes to csv
# inputs: dataset, column index, csv name
# outputs: csv file 
summary_free_text <- function(dataset, column_name) {
  column_index <- which(colnames(dataset) == column_name)
  # pull out column
  free_text <- dataset[column_index]
  # drop rows with empty fields
  free_text <- drop_na(free_text)
  # send content of free_text (dataframe) to vector
  free_text <- pull(free_text)
  # write to csv
  path_name <- deparse(substitute(dataset))
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write.csv(free_text, csv_name)
}

# summarises a set of related logical vectors (responses to a single
# multiple-choice question with multiple selections possible)
# takes the set of vectors,
# sums the number of TRUE and FALSE selections for each,
# creates a new dataframe with summarised data, and
# calculates percentage of TRUE and FALSE for each,
# sorts dataset from large to small n, returns summary dataset, and writes to csv
# inputs: dataset, list of column indices, 
# list of multiple choice items, and the question name 
# outputs: summary dataframe, csv
summary_logic_set <- function(dataset, column_indices, 
                            multiple_choices, question_name) {
  # for each column, create a vector with n=true and n=false
  # empty vector to take counts of true
  sum_true <- c()
  # get count of TRUE for each column; add count to vector
  for (i in column_indices) {
    a <- sum(dataset[i] == TRUE)
    sum_true <- c(sum_true, a)
  }
  # empty vector to take counts of false
  sum_false <- c()
  # get count for each column as indexed by questionIDs; add count to vector
  for (i in column_indices) {
    a <- sum(dataset[i] == FALSE)
    sum_false <- c(sum_false, a)
  }
  # combine counts into data-frame; row names are multiple choice options
  sum_data <- data.frame(multiple_choices, sum_true, sum_false)
  colnames(sum_data) <- c(question_name, "count_yes", "count_no")
  # add percentage columns
  sum_data$percentage_yes <- 
    sum_data$count_yes / nrow(dataset) * 100
  sum_data$percentage_no <- 
    sum_data$count_no / nrow(dataset) * 100
  sum_data <- arrange(sum_data, desc(percentage_yes))
  # write to csv
  path_name <- deparse(substitute(dataset))
  csv_title <- str_c(path_name, question_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(sum_data, csv_name)
  # return dataset
  return(sum_data)
}

# summarises a factor
# counts responses for each level, calculate percentages,
# writes summary data to csv, returns summary dataset
# inputs: dataset, column name
# outputs: dataset, csv
summary_factor_unordered <- function(dataset, column_name) {
  # get column index for column name
  column_index <- which(colnames(dataset) == column_name)
  # create new dataframe for summary data
  df <- count(dataset, dataset[column_index])
  # add percentage column
  df$percentage <- df$n / nrow(dataset) * 100
  df <- arrange(df, desc(n))
  # write summary data to csv
  path_name <- deparse(substitute(dataset))
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(df, csv_name)
  return(df)
}

# as above, but drops NA rows
summary_factor_no_na_unordered <- function(dataset, column_name) {
  # get column index for column name
  column_index <- which(colnames(dataset) == column_name)
  # create new dataframe for summary data
  df <- count(dataset, dataset[column_index])
  df <- drop_na(df)
  # add percentage column
  df$percentage <- df$n / nrow(dataset) * 100
  df <- arrange(df, desc(n))
  # write summary data to csv
  path_name <- deparse(substitute(dataset))
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(df, csv_name)
  return(df)
}

# same as summary_factor_unordered, but does not sort by n,
# and relevels factor according to list
# inputs: dataset, column name, list of factor levels
# outputs: summary dataset, csv
summary_factor_ordered <- function(dataset, column_name, factor_levels) {
  # get string from dataset name before it's parsed elsewhere in the function
  path_name <- deparse(substitute(dataset))
  # get column index for column name
  column_index <- which(colnames(dataset) == column_name)
  dataset[[column_index]] <- factor(dataset[[column_index]],
                                    levels = factor_levels)
  # create new dataframe for summary data
  df <- count(dataset, dataset[[column_index]], .drop = FALSE)
  df <- drop_na(df)
  # add percentage column
  df$percentage <- df$n / nrow(dataset) * 100
  colnames(df)[1] <- column_name
  # write summary data to csv
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(df, csv_name)
  return(df)
}

# slight modification of above function to use nested in another function
# path_name <- deparse(substitute(dataset)) does not work when nested,
# so slightly rewritten to have path name as function input
summary_factor_ordered_hq <- function(pathname, dataset, column_name, factor_levels) {
  path_name <- pathname
  # get column index for column name
  column_index <- which(colnames(dataset) == column_name)
  dataset[[column_index]] <- factor(dataset[[column_index]],
                                    levels = factor_levels)
  # create new dataframe for summary data
  df <- count(dataset, dataset[[column_index]])
  df <- drop_na(df)
  # add percentage column
  df$percentage <- df$n / nrow(dataset) * 100
  colnames(df)[1] <- column_name
  # write summary data to csv
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(df, csv_name)
  return(df)
}

# slight modification of above function to use nested in another function
# path_name <- deparse(substitute(dataset)) does not work when nested,
# so slightly rewritten to have path name as function input
summary_logic_set_hq <- function(pathname, dataset, column_indices, 
                                 multiple_choices, question_name) {
  path_name <- pathname
  # for each column, create a vector with n=true and n=false
  # empty vector to take counts of true
  sum_true <- c()
  # get count of TRUE for each column; add count to vector
  for (i in column_indices) {
    a <- sum(dataset[i] == TRUE)
    sum_true <- c(sum_true, a)
  }
  # empty vector to take counts of false
  sum_false <- c()
  # get count for each column as indexed by questionIDs; add count to vector
  for (i in column_indices) {
    a <- sum(dataset[i] == FALSE)
    sum_false <- c(sum_false, a)
  }
  # combine counts into data-frame; row names are multiple choice options
  sum_data <- data.frame(multiple_choices, sum_true, sum_false)
  colnames(sum_data) <- c(question_name, "count_yes", "count_no")
  # add percentage columns
  sum_data$percentage_yes <- 
    sum_data$count_yes / nrow(dataset) * 100
  sum_data$percentage_no <- 
    sum_data$count_no / nrow(dataset) * 100
  sum_data <- arrange(sum_data, desc(percentage_yes))
  # write to csv
  csv_title <- str_c(path_name, question_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write_csv(sum_data, csv_name)
  # return dataset
  return(sum_data)
}

# ditto
summary_free_text_hq <- function(pathname, dataset, column_name) {
  path_name <- pathname
  column_index <- which(colnames(dataset) == column_name)
  # pull out column
  free_text <- dataset[column_index]
  # drop rows with empty fields
  free_text <- drop_na(free_text)
  # send content of free_text (dataframe) to vector
  free_text <- pull(free_text)
  # write to csv
  csv_title <- str_c(path_name, column_name, sep = "/")
  csv_name <- str_c(csv_title, ".csv", sep = "")
  write.csv(free_text, csv_name)
}

# generates summaries of all sub-questions in a single harassment question
# using functions defined above
# inputs: dataset, name of first harassment question, 
# factor levels or multiple choice questions for each sub-question,
# and a search phrase to identify all columns in "venue" question (hq2)
# outputs: csv files, and a list of all summary output datasets
one_hq <- function(dataset, hq1_name,
                   hq1_factor_levels,
                   hq3_factor_levels,
                   hq4_factor_levels,
                   search_phrase){
  pathname <- deparse(substitute(dataset))
  s_hq1 <- summary_factor_ordered_hq(pathname, dataset, 
                                     hq1_name, hq1_factor_levels)
  hq3_name <- str_c(hq1_name, "timing", sep = "_")
  s_hq3 <- summary_factor_ordered_hq(pathname, dataset,
                                     hq3_name, hq3_factor_levels)
  hq4_name <- str_c(hq1_name, "frequency", sep = "_")
  s_hq4 <- summary_factor_ordered_hq(pathname, dataset,
                                     hq4_name, hq4_factor_levels)
  c_venue <- column_chunk(dataset, search_phrase)
  c_venue <- head(c_venue, -1)
  hq2_name <- str_c(hq1_name, "venue", sep = "_")
  hq2_columns <- get_multiple_choice(dataset, 
                                     search_phrase, 
                                     c_venue)
  s_hq2 <- summary_logic_set_hq(pathname,
                                dataset, c_venue,
                                hq2_columns[,2],
                                hq2_name)
  free_text_name <- str_c(hq2_name, "free_text", sep = "_")
  summary_free_text_hq(pathname, dataset, free_text_name)
  return(c(s_hq1, s_hq2, s_hq3, s_hq4))
}

# as above, but with hq2 code removed, for in-person questions that had
# no venue sub-question
one_hq_in_person <- function(dataset, hq1_name,
                             hq1_factor_levels,
                             hq3_factor_levels,
                             hq4_factor_levels){
  pathname <- deparse(substitute(dataset))
  s_hq1 <- summary_factor_ordered_hq(pathname, dataset, 
                                     hq1_name, hq1_factor_levels)
  hq3_name <- str_c(hq1_name, "timing", sep = "_")
  s_hq3 <- summary_factor_ordered_hq(pathname, dataset,
                                     hq3_name, hq3_factor_levels)
  hq4_name <- str_c(hq1_name, "frequency", sep = "_")
  s_hq4 <- summary_factor_ordered_hq(pathname, dataset,
                                     hq4_name, hq4_factor_levels)
  return(c(s_hq1, s_hq3, s_hq4))
}

# produces a vector of summary stats
# inputs: vector
# outputs: a vector with length,
# min, 1st. qu, median, mean,
# 3rd qu., max, and sum of vector
subject_summary <- function(vector) {
  l <- length(vector)
  s <- summary(vector)
  t <- sum(vector)
  outline <- c(l, s[1], s[2],
               s[3], s[4],
               s[5], s[6], t)
  return(outline)
}

# produces a flipped bar chart of an unordered factor
plot_factor_unordered <- function(dataset, xaxis, yaxis, xlabel, ylabel){
  p <- ggplot(data = dataset,
              aes(x = reorder(.data[[xaxis]], .data[[yaxis]]),
                  y = .data[[yaxis]])) +
    geom_bar(stat = "identity", fill = "#6D120B",
             width = 0.7) +
    geom_text(aes(label = round(.data[[yaxis]], digits=0)), hjust = 1.1, color="white", size = 2.5) +
    ylab(ylabel) + xlab(xlabel) +
    theme_minimal() +
    coord_flip() +
    theme(aspect.ratio=15/10)
  return(p)
}

# produces a flipped bar chart of an ordered factor
plot_factor_ordered <- function(dataset, xaxis, yaxis, xlabel, ylabel){
  p <- ggplot(data = dataset,
              aes(x = fct_rev(as_factor(.data[[xaxis]])),
                  y = .data[[yaxis]])) +
    geom_bar(stat = "identity", fill = "#6D120B",
             width = 0.7) +
    geom_text(aes(label = round(.data[[yaxis]], digits=0)), hjust = 1.1, color="white", size = 2.5) +
    ylab(ylabel) + xlab(xlabel) +
    theme_minimal() +
    coord_flip() +
    theme(aspect.ratio=15/10)
  return(p)
}

# produces combined plot for all sub-questions in each harassment question
hq_plots <- function(list, file_name, path_name){
  hq1 <- as.data.frame(list[1:3])
  hq2 <- as.data.frame(list[4:8])
  hq3 <- as.data.frame(list[9:11])
  hq4 <- as.data.frame(list[12:14])
  hq1_x <- colnames(hq1[1])
  hq1_y <- colnames(hq1[2])
  hq2_x <- colnames(hq2[1])
  hq2_y <- colnames(hq2[2])
  hq3_x <- colnames(hq3[1])
  hq3_y <- colnames(hq3[2])
  hq4_x <- colnames(hq4[1])
  hq4_y <- colnames(hq4[2])
  p1 <- plot_factor_ordered(hq1,
                            hq1_x,
                            hq1_y,
                            "Have you been harassed in this way?",
                            "Number of respondents")
  p2 <- plot_factor_unordered(hq2, 
                              hq2_x,
                              hq2_y, 
                              "Where did you experience this kind of harassment?", 
                              "Number of respondents")
  p3 <- plot_factor_ordered(hq3,
                            hq3_x,
                            hq3_y,
                            "When did this kind of harassment begin?",
                            "Number of respondents")
  p4 <- plot_factor_ordered(hq4,
                            hq4_x,
                            hq4_y,
                            "How many times has this occurred since the start of the pandemic?",
                            "Number of respondents")
  combi_plot <- ggarrange(p1, 
                          p3,
                          p4,
                          p2, 
                          ncol = 2, nrow = 2,
                          align = "hv",
                          widths = c(1,2))
  ggsave(filename = file_name,
         path = path_name,
         plot = combi_plot)
  print(combi_plot)
  return(combi_plot)
}

# as above, but with hq2 code removed, for in-person questions that had
# no venue sub-question
hq_plots2 <- function(list, file_name, path_name){
  hq1 <- as.data.frame(list[1:3])
  hq3 <- as.data.frame(list[4:6])
  hq4 <- as.data.frame(list[7:9])
  hq1_x <- colnames(hq1[1])
  hq1_y <- colnames(hq1[2])
  hq3_x <- colnames(hq3[1])
  hq3_y <- colnames(hq3[2])
  hq4_x <- colnames(hq4[1])
  hq4_y <- colnames(hq4[2])
  p1 <- plot_factor_ordered(hq1,
                            hq1_x,
                            hq1_y,
                            "Have you been harassed in this way?",
                            "Number of respondents")
  p1 <- p1 + theme(axis.text.x=element_blank())
  p3 <- plot_factor_ordered(hq3,
                            hq3_x,
                            hq3_y,
                            "When did this kind of harassment begin?",
                            "Number of respondents")
  p4 <- plot_factor_ordered(hq4,
                            hq4_x,
                            hq4_y,
                            "How many times has this occurred since the start of the pandemic?",
                            "Number of respondents")
  combi_plot <- ggarrange(p1, 
                          p3,
                          p4,
                          ncol = 2, nrow = 2,
                          align = "hv")
  ggsave(filename = file_name,
         path = path_name,
         plot = combi_plot)
  print(combi_plot)
  return(combi_plot)
}

#####

##### Data import and outlier removal
#####
wos <- read.csv("wos_clean.csv", stringsAsFactors = TRUE)

# participant was an extreme outlier on harassment intensity,
# had given identical responses to all publicity questions,
# and other responses indicated untrustworthy or inattentive responses
wos <- filter(wos, response_ID != 209)

dir.create("wos")
#####
```

## Methods
To survey researchers who had published on COVID-19, we extracted a list of corresponding author email addresses from Web of Science, drawing from all research articles, editorials, and review papers that mentioned COVID as a keyword. We then limited the pool to 35,830 email addresses that appeared more than once (indicating multiple publications) and emailed a random selection of 9955 researchers. This was the limit set by our institutional subscription to Alchemer, the survey platform we used. Recruitment and reminder emails, and a printout of the survey from Alchemer, are available at [osf.io/3bn9u](https://osf.io/3bn9u/wiki/home/). 

Because of the sensitive nature of the subject, *Science* applied for ethical review of the survey through BRANY (Biomedical Research Alliance of New York), an independent review board. The IRB protocol (BRANY SBER IRB #: 21-141-972) is available at [osf.io/3bn9u](https://osf.io/3bn9u/wiki/home/). 

Cathleen O’Grady, a contributing correspondent for *Science*, designed and conducted the survey, analyzed the data and published a [story](http://www.science.org/content/article/overwhelmed-hate-covid-19-scientists-face-avalanche-abuse-survey-shows) about it in the news section of *Science* magazine, March 25, 2022. Meta-scientist Tim Errington advised on the IRB process, survey methods, and statistical analysis. Martin Enserink, International News Editor at *Science*, provided editorial input.

Of the 9955 emails sent, 9585 were delivered, with some bounced emails presumably due to researchers changing institutions. We received 511 responses and removed one we questioned because it had identical answers across multiple questions. [A similar survey](https://www.science.org/pb-assets/science.abq1755/aaas_analysis.html) was sent to 59,653 members of the American Association for the Advancement of Science, *Science's* publisher, representing a wide range of disciplines; 1281 responded. In order to allow participants to share only the information they were comfortable sharing, and in line with the IRB-approved consent procedure, all questions were optional. This means that many questions were not answered by all participants, and have some "NA" (empty) responses.

Below, we show summary results for each question in the survey. As with any survey, it is very likely that certain kinds of people responded more than others. Targets of abuse may have been more likely to respond, and in order to try to limit the effect of this, our recruitment email specifically asked people with no experience of harassment to fill in the survey. However, the skew could also operate in the opposite direction: People who have experienced harassment could also be more worried about anonymity or less willing to discuss their experiences. Either way, the fact that respondents self-select into filling in the survey mean that the results cannot be taken to represent all COVID-19 scientists, or scientists more generally. These results also rely on self-report and on invididuals' interpretations of our questions, which further undermine the quality of all survey data. Results should all be interpreted with caution.

Because of the number of different questions and because we did not have specific hypotheses about our results, we have treated this as an exploratory dataset. We have not used significance testing, which could lend undue weight to tentative findings, instead calculating only descriptive statistics and effect sizes. For a discussion of the inappropriate use of null hypothesis significance testing, see: Szucs, D., & Ioannidis, J. (2017). When null hypothesis significance testing is unsuitable for research: a reassessment. *Frontiers in human neuroscience*, 11, 390.

For the sake of transparency, and to allow further analysis of the dataset, data and analysis code are available at [osf.io/3bn9u](https://osf.io/3bn9u/wiki/home/). However, given the sensitive nature of the subject, the public dataset has been anonymized, removing all potentially identifying details (including answers related to location, discipline, and demographics). We are open to collaboration in further analyzing the data, but access to the full dataset will be dependent on additional ethical review. Please contact us at intimidationsurvey@cathleenogrady.com if you are interested in this.

## Section 1: Discipline, publications and public attention

#### Have you read and understood the above consent statements and do you agree to participate in the survey?*
All rows without consent were removed during data cleaning.

#### Have you published or co-authored research or commentary—in a peer-reviewed academic journal, or on a preprint server—that deals in some way with the COVID-19 pandemic?  
All rows without confirmation of having published at least one COVID-19 paper were removed during data cleaning.

#### Please choose the discipline(s) that most closely describe(s) your COVID-19 publication(s)
Participants could select multiple discipline options. Free-text "other" responses covered a wide range of disciplines, including ethics, history of medicine, nutrition, and aerosol physics.
```{r covid_papers_discipline}
# export summaries of free text responses
summary_free_text(wos, "covid_papers_discipline_free_text")
# get column indices for question
c_covid_papers_discipline <- column_chunk(wos, "covid_papers_discipline_")
# check whether last item in printout is a free text field
# if it is, remove final index
c_covid_papers_discipline <- head(c_covid_papers_discipline, -1)
# get multiple choice options
o_covid_papers_discipline <- get_multiple_choice(wos, 
                                                 "covid_papers_discipline_", 
                                                 c_covid_papers_discipline)
# format multiple choice options for summary table and plot
o_covid_papers_discipline[9,2] <- "Social and \nbehavioral science"
o_covid_papers_discipline[10,2] <- "Other (please describe)"
# generate output dataset
s_covid_papers_discipline <- summary_logic_set(wos, 
                                             c_covid_papers_discipline, 
                                             o_covid_papers_discipline[,2], 
                                             "covid_papers_discipline")
#plot
p_covid_papers_discipline <- plot_factor_unordered(s_covid_papers_discipline, 
                                        "covid_papers_discipline",
                                        "count_yes", 
                                        "Discipline of COVID publications", 
                                        "Number of respondents")

ggsave(filename = "covid_papers_discipline.png",
       path = "wos",
       plot = p_covid_papers_discipline)
```
```{r covid_papers_discipline_output, include = TRUE}
p_covid_papers_discipline
```

#### Approximately how many papers and preprints have you published or co-authored on COVID-19 since the start of the pandemic?
Participants could choose only one option. Despite the list of email addresses from Web of Science being limited to those that appeared more than once, three respondents selected "0 to 1". 
```{r number_of_covid_papers}
# check factor levels
count(wos, number_of_covid_papers)
factor_levels <- c("1 to 0",
                   "1 to 2",
                   "3 to 5",
                   "5 to 10",
                   ">10")
s_number_of_covid_papers <- summary_factor_ordered(wos, 
                                                   "number_of_covid_papers", 
                                                   factor_levels)
# rename strange factor level
levels(s_number_of_covid_papers$number_of_covid_papers)[levels(s_number_of_covid_papers$number_of_covid_papers) 
                                                        == "1 to 0"] <- "0 to 1"
# plot
p_number_of_covid_papers <- plot_factor_ordered(s_number_of_covid_papers, 
                                                   "number_of_covid_papers",
                                                   "n", 
                                                   "Number of COVID papers", 
                                                   "Number of respondents")
ggsave(filename = "number_of_covid_papers.png",
       path = "wos",
       plot = p_number_of_covid_papers)
```
```{r number_of_covid_papers_output, include = TRUE}
p_number_of_covid_papers
```

#### In what country is the main institution through which you do your COVID-19 research?
```{r research_country}
s_research_country <- summary_factor_unordered(wos, "research_country")

p_research_country <- plot_factor_unordered(s_research_country, 
                                                   "research_country",
                                                   "n", 
                                                   "", 
                                                   "Number of respondents")
ggsave(filename = "research_country.png",
       path = "wos",
       plot = p_research_country)
```
```{r research_country_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_research_country
```

#### In what country do you live? 
```{r residence_country}
s_residence_country <- summary_factor_unordered(wos, "residence_country")



p_residence_country <- plot_factor_unordered(s_residence_country, 
                                            "residence_country",
                                            "n", 
                                            "", 
                                            "Number of respondents")

ggsave(filename = "residence_country.png",
       path = "wos",
       plot = p_residence_country)
```
```{r residence_country_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_residence_country
```

#### Have you received any public attention as a COVID-19 researcher, or have you spoken publicly about any matters related to COVID-19? Please select all that apply, and indicate how frequent the publicity has been:
```{r publicity}
# export summaries of free text responses
summary_free_text(wos, "publicity_free_text")

# too many columns start with this word, so column indices hard-coded
# check these indices in case of later column deletion etc.
c_publicity <- 21:29
# get multiple choice options
o_publicity <- get_multiple_choice(wos, "publicity", 
                                   c_publicity)
publicity_headings <- o_publicity[[2]]
publicity_factor_levels <- c(">50 times", 
                             "21-50 times", 
                             "11-20 times", 
                             "6-10 times", 
                             "3-5 times", 
                             "Twice", 
                             "Once", 
                             "Never")
# change factor levels in each column
for (i in c_publicity) {
  wos[[i]] <- factor(wos[[i]], 
                     levels = publicity_factor_levels)
}
# recheck factor levels
for (i in c_publicity) {
  print(count(wos, wos[i]))
}
s_publicity <- c()
# set factor levels as column 1
s_publicity <- cbind(s_publicity, c(publicity_factor_levels,"NA"))
# for each question, generate summary results,
# calculate percentage for each frequency level
# add both count and percentage columns into results dataframe
for (i in c_publicity) {
  results <- count(wos, wos[i])
  results_pct <- c()
  for (i in results[,2]) {
    p <- pct(i, sum(results[,2]))
    results_pct <- c(results_pct, p)
  }
  s_publicity <- cbind(s_publicity, results[2], results_pct)
}
# create percentage column names
pct_col_names <- str_c(publicity_headings, "(%)", sep = " ")
# zip names for count and percentage columns together
var_names <- c()
for (i in seq_along(publicity_headings)) {
  var_names <- c(var_names, publicity_headings[i], pct_col_names[i])
}
# set column names
col_names <- c("Frequency", var_names)
colnames(s_publicity) <- col_names
s_publicity
write_csv(as_tibble(s_publicity), "wos/publicity.csv")

# pivot for stacked bar plot
p_publicity_data <- pivot_longer(s_publicity, all_of(publicity_headings), 
                           names_to = "venue",
                           values_to = "count")
p_publicity_data <- p_publicity_data[-c(2:10)]
p_publicity_data$Frequency <- as_factor(p_publicity_data$Frequency)
p_publicity_data$venue <- as_factor(p_publicity_data$venue)
palette <- c("#440500", "#551E1A", 
             "#663733", "#77504D", 
             "#896967", "#9A8280", 
             "#AB9B9A", "#BCB4B3",
             "#cdcdcd")
# plot
p_publicity <- ggplot(p_publicity_data,
       aes(fill = Frequency,
           x = fct_rev(venue),
           y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Public attention venue") +
  ylab("Number of participants") +
  theme(legend.title= element_blank()) +
  scale_fill_manual(values = palette)
ggsave("wos/publicity.png")
```
```{r publicity_output, include = TRUE}
p_publicity
```

#### Please describe the other platform(s) through which you have received public attention as a COVID-19 researcher: 
Free-text responses included industry advice, speaking to local community groups, writing opinion pieces, and being mentioned in (but not interviewed for) news articles about research.

#### Exposure intensity scores
To gauge each respondent's overall level of exposure, we created a composite "exposure intensity" score that assigned a point for each separate publicity venue, multiplied by the middle range of each frequency category. For instance, someone who said they'd been on TV news would get one point; if they said this had happened twice, it would be 2 points; if they said 3-5 times, it would be 4 points (the middle of the 3-5 range). If they said they had also been on radio news twice, this would give them an additional two points, for a total score of 6. 

104 out of 510 respondents reported no exposure at all, resulting in a score of 0. Progressively fewer researchers had higher and higher exposure scores. 
```{r media_intensity}
media_intensity <- as_tibble(wos$response_ID)
# add each publicity column to dataframe
for (i in c_publicity) {
  media_intensity <- cbind(media_intensity, wos[i])
}
# convert to character, and replace NA with "Blank" for greater human readability
media_intensity <- lapply(media_intensity, as.character)
media_intensity <- as.data.frame(map(media_intensity, replace_na, "Blank"))
# create factor list
media_intensity_levels <- c(publicity_factor_levels, "Blank")
media_cols <- 2:10
# change all columns to factor levels, including "blank"
for (i in media_cols) {
  media_intensity[[i]] <- factor(media_intensity[[i]],
                     levels = media_intensity_levels)
}
# check
str(media_intensity)
# empty vector
media_intensity_score <- c()
# for each row in harassment dataframe
for (r in 1:nrow(media_intensity)) {
  # open the media count for that participant
  k = 0
  # for each type of media
  for (i in media_cols) {
    m = 0
    # add points depending on answer
    if (media_intensity[r, i] == "Never") {
      m = 0
    } else if (media_intensity[r, i] == "Once"){
      m = 1
    } else if (media_intensity[r, i] == "Twice") {
      m = 2
    } else if (media_intensity[r, i] == "3-5 times") {
      m = 4
    } else if (media_intensity[r, i] == "6-10 times") {
      m = 8
    } else if (media_intensity[r, i] == "11-20 times") {
      m = 15.5
    } else if (media_intensity[r, i] == "21-50 times") {
      m = 35.5
    } else if (media_intensity[r, i] == ">50 times") {
      m = 50
    }
    k = k + m
  }
  # add the participant's score to the vector
  media_intensity_score <- c(media_intensity_score, k)
}
# add the vector to media intensity and wos dataframes
media_intensity$media_intensity_score <- media_intensity_score
wos$media_intensity_score <- media_intensity_score

# distribution of media intensity scores
p_media_intensity <- ggplot(media_intensity, aes(x=media_intensity_score)) +
  geom_histogram(binwidth = 1, color="#6D120B") +
  theme_minimal() +
  xlab("Exposure intensity score") +
  ylab("Number of respondents") +
  theme(aspect.ratio=10/10)

ggsave(filename = "media_intensity.png",
       path = "wos",
       plot = p_media_intensity)

```
```{r media_intensity_output, include = TRUE}
p_media_intensity
```


#### In what country or countries have you received this public attention? 
Participants could select multiple options.
```{r publicity_countries}
# get column indices for question
c_publicity_countries <- column_chunk(wos, "publicity_countries_")
# get multiple choice options
o_publicity_countries <- get_multiple_choice(wos, "publicity_countries_", 
                                             c_publicity_countries)
# format multiple choice options for summary table and plot
o_publicity_countries[,2] <- str_to_title(o_publicity_countries[,2])
# generate output dataset
s_publicity_countries <- summary_logic_set(wos, 
                                               c_publicity_countries, 
                                               o_publicity_countries[,2], 
                                               "publicity_countries")

p_publicity_countries <- plot_factor_unordered(s_publicity_countries, 
                                             "publicity_countries",
                                             "count_yes", 
                                             "", 
                                             "Number of respondents")
ggsave(filename = "publicity_countries.png",
       path = "wos",
       plot = p_publicity_countries)

```
```{r publicity_countries_output, include = TRUE, fig.dim = c(14, 12), out.width = "100%"}
p_publicity_countries
```

#### Please choose the discipline(s) or subject(s) that most closely describe the subject(s) you have publicly spoken about:
Free text "other" responses included ethics, environmental health, diagnostic testing, and aerosol physics.
```{r publicity_discipline}
# export summaries of free text responses
summary_free_text(wos, "publicity_discipline_free_text")
# get column indices for question
c_publicity_discipline <- column_chunk(wos, "publicity_discipline_")
# check whether last item in printout is a free text field
# if it is, remove final index
c_publicity_discipline <- head(c_publicity_discipline, -1)
# get multiple choice options
o_publicity_discipline <- get_multiple_choice(wos, "publicity_discipline_", 
                                         c_publicity_discipline)
# format multiple choice options for summary table and plot
o_publicity_discipline[8,2] <- "Effects of COVID-19 \ne.g. long COVID"
o_publicity_discipline[10,2] <- "Social and \n behavioral science"
o_publicity_discipline[11,2] <- "Public health measures \n e.g. lockdowns, vaccines"
o_publicity_discipline[13,2] <- "Other (please describe)"
# generate output dataset
s_publicity_discipline <- summary_logic_set(wos, c_publicity_discipline, 
                                       o_publicity_discipline[,2], 
                                       "publicity_discipline")


p_publicity_discipline <- plot_factor_unordered(s_publicity_discipline, 
                                               "publicity_discipline",
                                               "count_yes", 
                                               "Publicity discipline(s)", 
                                               "Number of respondents")
ggsave(filename = "publicity_discipline.png",
       path = "wos",
       plot = p_publicity_discipline)
```
```{r publicity_discipline_output, include = TRUE}
p_publicity_discipline
```

#### In the course of your work, have you publicly supported, or advocated for, any of the following? (Select all that apply.)
Free text "other" responses included decarceration, masking in schools, school closure, contact tracing, and mental health.
```{r publicity_topic}
# export summaries of free text responses
summary_free_text(wos, "publicity_topic_free_text")
# get column indices for question
c_publicity_topic <- column_chunk(wos, "publicity_topic_")
# check whether last item in printout is a free text field
# if it is, remove final index
c_publicity_topic <- head(c_publicity_topic, -1)
# get multiple choice options
o_publicity_topic <- get_multiple_choice(wos, "publicity_topic_", 
                                                 c_publicity_topic)
# format multiple choice options for summary table and plot
o_publicity_topic[1,2] <- "Mask-wearing"
o_publicity_topic[5,2] <- "Not vaccinating certain \n groups e.g. children"
o_publicity_topic[6,2] <- "Vaccine mandates"
o_publicity_topic[7,2] <- "Hand-washing & hygiene"
o_publicity_topic[11,2] <- "Using hydroxychloroquine"
o_publicity_topic[12,2] <- "Not using hydroxychloroquine"
o_publicity_topic[13,2] <- "Using ivermectin"
o_publicity_topic[14,2] <- "Not using ivermectin"
o_publicity_topic[15,2] <- "Lockdowns"
o_publicity_topic[16,2] <- "Not locking down"
o_publicity_topic[17,2] <- "Natural origin of the virus"
o_publicity_topic[18,2] <- "Lab origin of the virus"
# generate output dataset
s_publicity_topic <- summary_logic_set(wos, c_publicity_topic, 
                                       o_publicity_topic[,2], 
                                               "publicity_topic")

p_publicity_topic <- plot_factor_unordered(s_publicity_topic, 
                                                "publicity_topic",
                                                "count_yes", 
                                                "Publicity topic(s)", 
                                                "Number of respondents")
ggsave(filename = "publicity_topic.png",
       path = "wos",
       plot = p_publicity_topic)
```
```{r publicity_topic_output, include = TRUE}
p_publicity_topic
```


## Section 2: Harassment and intimidation
Participants were asked a series of questions about whether they had experienced a range of harassment types as a result of their work on COVID-19. If a participant responded "yes" to a particular kind of harassment, they were then asked about venue, onset, and frequency of this type of harassment, before proceeding to the next question. This means that responses to questions about onset, frequency and venue are from a subset of the total number of participants (only those who responded "yes" to the relevant harassment question).
```{r harassment_setup}
# create response option lists 
hq1_factor_levels <- c("Yes",
                       "No",
                       "Not sure",
                       "Decline to answer")
hq2_options <- c("Twitter",
                 "Facebook",
                 "Instagram",
                 "YouTube",
                 "TikTok",
                 "LinkedIn",
                 "Other social media",
                 "Email",
                 "TV, newspaper, magazine, \nradio, or online news",
                 "Public comments on online news",
                 "Other online",
                 "Statements by public figures \ne.g. politicians",
                 "Physical mail",
                 "Text messages on your phone",
                 "Phone calls",
                 "In person",
                 "Other (please describe")
hq3_factor_levels <- c("Soon after the pandemic began",
                       "Within the past year",
                       "Within the past six months",
                       "Within the past three months",
                       "Within the past month",
                       "Within the past week")
hq4_factor_levels <- c("Once",
                       "Twice",
                       "3-5 times",
                       "6-10 times",
                       "11-20 times",
                       "21-50 times",
                       ">50 times")
```

#### Have you experienced personal insults as a result of your work on COVID-19?
```{r insults}
s_insults <- one_hq(wos, "insults", 
                 hq1_factor_levels, 
                 hq3_factor_levels, 
                 hq4_factor_levels,
                 "^insults_venue_")
p_insults <- hq_plots(s_insults, "insults.png", "wos")
```
```{r insults_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_insults
```

#### Have you experienced comments on your physical appearance? For instance, have you been called "ugly" or "fat" as a result of your work on COVID-19?
```{r physical_appearance}
s_physical_appearance <- one_hq(wos, "physical_appearance", 
                                hq1_factor_levels, 
                                hq3_factor_levels, 
                                hq4_factor_levels,
                                "physical_appearance_venue_")
p_physical_appearance <- hq_plots(s_physical_appearance, 
                                  "physical_appearance.png", "wos")
```
```{r physical_appearance_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_physical_appearance
```

#### Have you experienced insults targeting your race, gender, sexuality, gender identity, or another group characteristic as a result of your work on COVID-19?
```{r group_characteristic_insults}
s_group_characteristic_insults <- one_hq(wos, "group_characteristic_insults", 
                                         hq1_factor_levels, 
                                         hq3_factor_levels, 
                                         hq4_factor_levels,
                                         "group_characteristic_insults_venue_")
p_group_characteristic_insults <- hq_plots(s_group_characteristic_insults,
                                           "group_characteristic_insults.png", "wos")
```
```{r group_characteristic_insults_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_group_characteristic_insults
```

#### Have you experienced a high volume/frequency of contact from a single individual as a result of your work on COVID-19?
```{r high_volume_individual}
s_high_volume_individual <- one_hq(wos, "high_volume_individual", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "high_volume_individual_venue_")
p_high_volume_individual <- hq_plots(s_high_volume_individual, 
                                     "high_volume_individual.png", "wos")
```
```{r high_volume_individual_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_high_volume_individual
```

#### Have you experienced a high volume/frequency of contact from many individuals as a result of your work on COVID-19?
```{r high_volume_many}
s_high_volume_many <- one_hq(wos, "high_volume_many", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "high_volume_many_venue_")
p_high_volume_many <- hq_plots(s_high_volume_many, 
                               "high_volume_many.png", "wos")
```
```{r high_volume_many_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_high_volume_many
```

#### Have you experienced allegations of dishonesty or corruption as a result of your work on COVID-19?
```{r corruption_allegations}
s_corruption_allegations <- one_hq(wos, "corruption_allegations", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "corruption_allegations_venue_")
p_corruption_allegations <- hq_plots(s_corruption_allegations, 
                                     "corruption_allegations.png", "wos")
```
```{r corruption_allegations_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_corruption_allegations
```

#### Have you experienced attacks on your professional capabilities as a result of your work on COVID-19?
```{r professional_capabilities}
s_professional_capabilities <- one_hq(wos, "professional_capabilities", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "professional_capabilities_venue_")
p_professional_capabilities <- hq_plots(s_professional_capabilities, 
                                        "professional_capabilities.png", "wos")
```
```{r professional_capabilities_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_professional_capabilities
```

#### Have you experienced unwanted publication of your personal information, such as your home or work address (“doxxing”) as a result of your work on COVID-19?
```{r doxxing}
s_doxxing <- one_hq(wos, "doxxing", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "doxxing_venue_")
p_doxxing <- hq_plots(s_doxxing,
                      "doxxing.png", "wos")
```
```{r doxxing_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_doxxing
```

#### Have you experienced wishes of harm or death (without threats to carry out that harm) as a result of your work on COVID-19?
```{r death_harm_wishes}
s_death_harm_wishes <- one_hq(wos, "death_harm_wishes", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "death_harm_wishes_venue_")
p_death_harm_wishes <- hq_plots(s_death_harm_wishes,
                                "death_harm_wishes.png", "wos")
```
```{r death_harm_wishes_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_death_harm_wishes
```

#### Have you experienced suggestions that you harm yourself as a result of your work on COVID-19?
```{r harm_yourself}
s_harm_yourself <- one_hq(wos, "harm_yourself", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "harm_yourself_venue_")
p_harm_yourself <- hq_plots(s_harm_yourself,
                            "harm_yourself.png", "wos")
```
```{r harm_yourself_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_harm_yourself
```

#### Have you experienced threats of physical harm, including sexual assault as a result of your work on COVID-19?
```{r harm_threats}
s_harm_threats <- one_hq(wos, "harm_threats", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "harm_threats_venue_")
p_harm_threats <- hq_plots(s_harm_threats,
                           "harm_threats.png", "wos")
```
```{r harm_threats_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_harm_threats
```

#### Have you experienced death threats as a result of your work on COVID-19?
```{r death_threats}
s_death_threats <- one_hq(wos, "death_threats", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "death_threats_venue_")
p_death_threats <- hq_plots(s_death_threats,
                            "death_threats.png", "wos")
```
```{r death_threats_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_death_threats
```

#### Have you experienced wishes of harm directed at your family (without threats to carry out that harm) as a result of your work on COVID-19?
```{r family_harm_wishes}
s_family_harm_wishes <- one_hq(wos, "family_harm_wishes", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "family_harm_wishes_venue_")
p_family_harm_wishes <- hq_plots(s_family_harm_wishes, 
                                 "family_harm_wishes.png", "wos")
```
```{r family_harm_wishes_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_family_harm_wishes
```

#### Have you experienced threats of harm directed at your family as a result of your work on COVID-19?
```{r family_harm_threats}
s_family_harm_threats <- one_hq(wos, "family_harm_threats", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "family_harm_threats_venue_")
p_family_harm_threats <- hq_plots(s_family_harm_threats, 
                                  "family_harm_threats.png", "wos")
```
```{r family_harm_threats_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_family_harm_threats
```

#### Have you experienced cyber attacks (for instance, hacking/phishing using fake links sent to emails/installation of viruses or malware) as a result of your work on COVID-19?
```{r cyber_attacks}
s_cyber_attacks <- one_hq(wos, "cyber_attacks", 
            hq1_factor_levels, 
            hq3_factor_levels, 
            hq4_factor_levels,
            "cyber_attacks_venue_")
p_cyber_attacks <- hq_plots(s_cyber_attacks, 
                            "cyber_attacks.png", "wos")
```
```{r cyber_attacks_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_cyber_attacks
```

```{r harassment_indexing}
# example of how to index resulting lists
hq1 <- as.data.frame(s_insults[1:3])
hq2 <- as.data.frame(s_insults[4:8])
hq3 <- as.data.frame(s_insults[9:11])
hq4 <- as.data.frame(s_insults[12:14])
```

```{r harassment_in_person_setup}
# different function needed because these hqs have no "venue" sub-question
# produce summaries for each harassment question
s_physical_mail <- one_hq_in_person(wos, "physical_mail", 
                    hq1_factor_levels, 
                    hq3_factor_levels, 
                    hq4_factor_levels)
s_vandalism <- one_hq_in_person(wos, "vandalism", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
s_unwanted_visits <- one_hq_in_person(wos, "unwanted_visits", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
s_protests <- one_hq_in_person(wos, "protests", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
s_physical_intimidation <- one_hq_in_person(wos, "physical_intimidation", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
```

#### Have you received suspicious physical mail as a result of your work on COVID-19?
```{r physical_mail}
s_physical_mail <- one_hq_in_person(wos, "physical_mail", 
                    hq1_factor_levels, 
                    hq3_factor_levels, 
                    hq4_factor_levels)
p_physical_mail <- hq_plots2(s_physical_mail,
                            "physical_mail.png", "wos")
```
```{r physical_mail_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_physical_mail
```

#### Have you experienced vandalism of your home or other property as a result of your work on COVID-19?
```{r vandalism}
s_vandalism <- one_hq_in_person(wos, "vandalism", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
p_vandalism <- hq_plots2(s_vandalism, 
                        "vandalism.png", "wos")
```
```{r vandalism_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_vandalism
```

#### Have you experienced unwanted visits to your home or workplace as a result of your work on COVID-19?
```{r unwanted_visits}
s_unwanted_visits <- one_hq_in_person(wos, "unwanted_visits", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
p_unwanted_visits <- hq_plots2(s_unwanted_visits, 
                              "unwanted_visits.png", "wos")
```
```{r unwanted_visits_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_unwanted_visits
```

#### Have you experienced group gatherings or protests outside your home or workplace as a result of your work on COVID-19?
```{r protests}
s_protests <- one_hq_in_person(wos, "protests", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
p_protests <- hq_plots2(s_protests, 
                       "protests.png", "wos")
```
```{r protests_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_protests
```

#### Have you experienced physical intimidation as a result of your work on COVID-19?
```{r physical_intimidation}
s_physical_intimidation <- one_hq_in_person(wos, "physical_intimidation", 
                                    hq1_factor_levels, 
                                    hq3_factor_levels, 
                                    hq4_factor_levels)
p_physical_intimidation <- hq_plots2(s_physical_intimidation,
                                    "physical_intimidation.png", "wos")
```
```{r physical_intimidation_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_physical_intimidation
```

```{r harassment_in_person_indexing}
# example of how to index resulting lists
hq1 <- as.data.frame(s_physical_mail[1:3])
hq3 <- as.data.frame(s_physical_mail[4:6])
hq4 <- as.data.frame(s_physical_mail[7:9])
```

#### Have you experienced any other type(s) of harassment as a result of your work on COVID-19?
```{r other_harassment}
s_other_harassment <- one_hq(wos, "other_harassment", 
                          hq1_factor_levels, 
                          hq3_factor_levels, 
                          hq4_factor_levels,
                          "other_harassment_venue_")
p_other_harassment <- hq_plots(s_other_harassment, 
                               "other_harassment.png", "wos")
```
```{r other_harassment_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_other_harassment
```

## Harassment summary results

#### Number of respondents reporting harassment
Each participant was assigned a "score" reflecting how many types of harassment they reported. For instance, a participant reporting only one kind of harassment would receive a score of 1; someone reporting eight kinds of harassment would receive a score of 8. Out of 510 respondents, 315 (61.8%) reported no harassment, and 195 (38.2%) reported at least one kind of harassment. Some participants report experiencing multiple categories of harassment.
```{r harassment_scores}
# empty tibble
harassment <- as_tibble(wos$response_ID)
# list of column names of harassment types
harassment_types <- c("insults", 
                     "physical_appearance",
                     "group_characteristic_insults",
                     "high_volume_individual",
                     "high_volume_many",
                     "corruption_allegations",
                     "professional_capabilities",
                     "doxxing",
                     "death_harm_wishes",
                     "harm_yourself",
                     "harm_threats",
                     "death_threats",
                     "family_harm_wishes",
                     "family_harm_threats",
                     "cyber_attacks",
                     "physical_mail",
                     "vandalism",
                     "unwanted_visits",
                     "protests",
                     "physical_intimidation",
                     "other_harassment")
# get list of column indices for main harassment questions
c_harassment_types <- c()
for (i in harassment_types) {
  search_phrase <- str_c("^", i, "$", sep = "")
  c_index <- grep(search_phrase, colnames(wos))
  c_harassment_types <- c(c_harassment_types, c_index)
}
# add each harassment column to dataframe
for (i in c_harassment_types) {
  harassment <- cbind(harassment, wos[i])
}
# change NA cells to string "Blank"
# needed later in script to create harassment composite score
harassment <- lapply(harassment, as.character)
harassment <- as.data.frame(map(harassment, replace_na, "Blank"))
# set factor levels
harassment_factor_levels <- c("Yes", "No", "Not sure", 
                              "Decline to answer",
                              "Blank")
# change all columns to factor levels, including "blank"
harassment_cols <- 2:ncol(harassment)
for (i in harassment_cols) {
  harassment[[i]] <- factor(harassment[[i]],
                                 levels = harassment_factor_levels)
}
# check
str(harassment)

# empty vector
harassment_score <- c()
# for each row in harassment dataframe
for (r in 1:nrow(harassment)) {
  # open the harassment count for that participant
  k = 0
  # for each type of harassment
  for (i in harassment_cols) {
    # if the participant said yes, add a point to their score
    if (harassment[r, i] == "Yes") {
      k = k + 1
    }
  }
  # add the participant's score to the vector
  harassment_score <- c(harassment_score, k)
}
# add the vector to harassment and wos dataframes
harassment$harassment_score <- harassment_score
wos$harassment_score <- harassment_score
# add factor versions of the scores to dataframes
harassment$harassment_score_factor <- factor(harassment$harassment_score)
wos$harassment_score_factor <- factor(wos$harassment_score)
# create summary table of counts
harassment_score_summary <- count(harassment, harassment_score_factor, 
                                  .drop = FALSE)
colnames(harassment_score_summary) <- c("Harassment score", "Number of respondents")
#write to csv
write.csv(harassment_score_summary, "wos/harassment_score.csv")

# plot distribution of harassment scores
p_harassment_scores <- ggplot(wos, aes(x=harassment_score)) +
  geom_histogram(binwidth = 1, color="white", fill="#6D120B") +
  theme_minimal() +
  xlab("Harassment score") +
  ylab("Number of participants") +
  theme(aspect.ratio=10/10)

ggsave(filename = "harassment_scores.png",
       path = "wos",
       plot = p_harassment_scores)
```
```{r harassment_scores_output, include = TRUE}
kable(harassment_score_summary, align = "c")
#p_harassment_scores
```
#### Harassment among media-experienced researchers only
This survey found a much lower rate of harassment than a survey conducted by *Nature*, which found that 81% of 321 scientists surveyed reported at least occasional abuse. However, the survey samples differed substantially: *Nature* surveyed researchers on the COVID-19 media contact lists at science media centers in a range of countries, as well as researchers who had been prominent in media coverage. In contrast, our survey contacted researchers who had published on COVID-19, regardless of media coverage. This means that the sample surveyed by *Nature* likely had far higher rates of public attention, which may explain a much higher rate of abuse.

In order to compare samples more closely, at the request of *Nature*, we subsetted the data to include only those participants who reported at least one media interview (TV, radio, print, online, or other). 310 respondents reported at least one interview, and of these 310 respondents, 161 (52%) reported at least one type of harassment. The fact that this number is lower than the figure found by *Nature* may be at least partially explained by a difference in prominence: Researchers speaking frequently to science media centers likely have a higher profile than the researchers even in this subset of our sample, who may have given just one interview since the start of the pandemic.
``` {r harassment_media_experienced}
# subset of responses that said yes to at least one of four news media options
wos_news_media <- filter(wos, 
               publicity_interview_on_tv_news != "Never" |
                 publicity_interview_on_radio_news != "Never" |
                 publicity_interview_in_written_print_or_online_news_media != "Never" |
                 publicity_interview_in_other_media != "Never")
# count of harassment scores for limited dataset
harassment_score_summary_news_media <- count(wos_news_media, harassment_score_factor, 
                                   .drop = FALSE)
# total number of participants
t <- sum(harassment_score_summary_news_media$n) #310
# number who reported at least one kind of harassment
r <- sum(harassment_score_summary_news_media$n[-1]) #161
# percentage who reported at least one kind of harassment
p <- pct(r, t) #52%
```


#### Harassment summary by type
Participants could select multiple categories. Personal insults and attacks on credibility or honesty were the most common, with protests, unwanted visits and physical intimidation much rarer.
```{r harassment_summary}


# dataframe for composite harassment results
harassment_summary <- c()
# get count of each response in each column and bump to summary dataframe
for (i in harassment_cols) {
  results_count <- count(harassment, harassment[i], .drop = FALSE)
  harassment_summary <- cbind(harassment_summary, results_count[[2]])
}
colnames(harassment_summary) <- harassment_types
rownames(harassment_summary) <- harassment_factor_levels
write.csv(harassment_summary, "wos/harassment_summary_by_type.csv")

# wrangle data for plotting
harassment_names <- c("Personal insults", 
                      "Comments on appearance",
                      "Insults targeting identity",
                      "Excessive contact from an individual",
                      "Excessive contact from many people",
                      "Allegations of dishonesty or corruption",
                      "Attacks on professional capabilities",
                      "Doxxing (publication of address)",
                      "Wishes of harm or death",
                      "Suggestions to self-harm",
                      "Threats of physical harm",
                      "Death threats",
                      "Wishes of harm directed at family",
                      "Threats of harm directed at family",
                      "Cyber attacks",
                      "Suspicious physical mail",
                      "Vandalism of home or property",
                      "Unwanted visits to home or work",
                      "Protests outside home or work",
                      "Physical intimidation",
                      "Other harassment")

# dataframe with harassment types and count_yes summary for each
p_harassment_data <- data.frame(harassment_names, harassment_summary[1,])
#plot
p_harassment_summary <- plot_factor_unordered(p_harassment_data, 
                                                   "harassment_names",
                                                   "harassment_summary.1...", 
                                                   "Type of harassment", 
                                                   "Number of respondents")
ggsave(filename = "harassment_summary.png",
       path = "wos",
       plot = p_harassment_summary)
```
```{r harassment_summary_output, include = TRUE}
p_harassment_summary
```

#### Harassment summary by venue
Free text responses mentioned emails directly to employers.
```{r harassment_venue}
venues <- c("venue_twitter",
            "venue_facebook",
            "venue_instagram",
            "venue_youtube",
            "venue_tiktok",
            "venue_linkedin",
            "venue_other_social_media",
            "venue_email",
            "venue_tv_newspaper_magazine_radio_online_news",
            "venue_public_comments_on_online_news",
            "venue_other_online",
            "venue_statements_by_public_figures_e.g.__politicians",
            "venue_physical_mail",
            "venue_text_messages_on_your_phone",
            "venue_phone_calls",
            "venue_in_person",
            "venue_other_please_describe")
t_harassment_venue <- c()
for (v in venues) {
  clist <- grep(v, colnames(wos))
  v_sum <- c()
  for (i in clist) {
    s <- (sum(wos[i] == TRUE))
    v_sum <- c(v_sum, s)
  }
  t_sum <- sum(v_sum)
  t_harassment_venue <- c(t_harassment_venue, t_sum)
}
s_harassment_venue <- data.frame(hq2_options, t_harassment_venue)
write.csv(s_harassment_venue, "wos/harassment_venue.csv")

#plot
p_harassment_venue <- plot_factor_unordered(s_harassment_venue, 
                                           "hq2_options",
                                           "t_harassment_venue", 
                                           "Harassment venue", 
                                           "Number of respondents")
p_harassment_venue
ggsave(filename = "harassment_venue.png",
       path = "wos",
       plot = p_harassment_venue)
```
```{r harassment_venue_output, include = TRUE}
p_harassment_venue
```

#### Harassment summary by timing
Most respondents reported that the harassment began soon after the pandemic began, or within the last year. Onset of harassment within the past six months was much less common.
```{r harassment_timing}
# empty tibble
harassment_timing <- as_tibble(wos$response_ID)
# get list of column indices for harassment timing questions
c_harassment_timing <- c()
for (i in harassment_types) {
  search_phrase <- str_c("^", i, "_timing", sep = "")
  c_index <- grep(search_phrase, colnames(wos))
  c_harassment_timing <- c(c_harassment_timing, c_index)
}
# add summary counts to dataframe
s_harassment_timing <- data.frame(c(hq3_factor_levels, "NA"))
for (i in c_harassment_timing) {
  wos[[i]] <- factor(wos[[i]], levels = hq3_factor_levels)
  c <- count(wos, wos[[i]],
             .drop = FALSE)
  cv <- (c[[2]])
  s_harassment_timing <- cbind(s_harassment_timing, cv)
}
colnames(s_harassment_timing) <- c("timing", harassment_names)
# add sum column
timing_sum <- c()
for (r in 1:nrow(s_harassment_timing)){
  s <- sum((s_harassment_timing[r, 2:22]))
  timing_sum <- c(timing_sum, s)
}
s_harassment_timing$timing_sum <- timing_sum
harassment_timing_total = sum(timing_sum[1:6])
timing_pct <- c()
for (r in 1:nrow(s_harassment_timing)){
  p <- pct(s_harassment_timing[r, 23], harassment_timing_total)
  timing_pct <- c(timing_pct, p)
}
s_harassment_timing$timing_pct <- timing_pct
s_harassment_timing <- relocate(s_harassment_timing, 
                                c(timing_sum, timing_pct), 
                                .after = timing)
# remove NA row
s_harassment_timing <- s_harassment_timing[-7,]
write.csv(s_harassment_timing, "wos/harassment_timing.csv")

# plot basic summary
p_harassment_timing <- plot_factor_ordered(s_harassment_timing,
                    "timing",
                    "timing_pct",
                    "Onset of each harassment type",
                    "Percentage")
p_harassment_timing
ggsave(filename = "harassment_timing.png",
       path = "wos",
       plot = p_harassment_timing)

# pivot for stacked bar plot
p_harassment_timing_data <- pivot_longer(s_harassment_timing, 
                                         all_of(harassment_names), 
                                 names_to = "harassment_type",
                                 values_to = "count")
p_harassment_timing_data <- p_harassment_timing_data[-c(2:3)]
p_harassment_timing_data$timing <- as_factor(p_harassment_timing_data$timing)
p_harassment_timing_data$harassment_type <- as_factor(p_harassment_timing_data$harassment_type)
ht_palette <- c("#560B06", 
                "#6E322E", 
                "#865956",
                "#9E807E", 
                "#B6A7A6",
                "#CECECE")
# plot
p_harassment_timing <- ggplot(p_harassment_timing_data,
                      aes(fill = timing,
                          x = fct_rev(harassment_type),
                          y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Harassment type") +
  ylab("Number of respondents") +
  theme(legend.title= element_blank()) +
  scale_fill_manual(values = ht_palette)

ggsave("wos/harassment_timing_stacked.png")
```
```{r harassment_timing_output, include = TRUE}
p_harassment_timing
```

#### Harassment summary by frequency
Some respondents reported frequent personal insults, attacks on credibility and honesty, and excessive contact from swarms or individuals. Some reported that even severe abuse, including doxxing and wishes of harm or death, had occurred more than 50 times.
```{r harassment_freq}
s_harassment_frequency <- as_tibble(wos$response_ID)
# get list of column indices for harassment timing questions
c_harassment_frequency <- c()
for (i in harassment_types) {
  search_phrase <- str_c("^", i, "_frequency", sep = "")
  c_index <- grep(search_phrase, colnames(wos))
  c_harassment_frequency <- c(c_harassment_frequency, c_index)
}
# add summary counts to dataframe
s_harassment_frequency <- data.frame(c(hq4_factor_levels, "NA"))
for (i in c_harassment_frequency) {
  wos[[i]] <- factor(wos[[i]], levels = hq4_factor_levels)
  c <- count(wos, wos[[i]],
             .drop = FALSE)
  cv <- (c[[2]])
  s_harassment_frequency <- cbind(s_harassment_frequency, cv)
}
colnames(s_harassment_frequency) <- c("frequency", harassment_names)
# add sum column
frequency_sum <- c()
for (r in 1:nrow(s_harassment_frequency)){
  s <- sum((s_harassment_frequency[r, 2:22]))
  frequency_sum <- c(frequency_sum, s)
}
s_harassment_frequency$frequency_sum <- frequency_sum
harassment_frequency_total = sum(frequency_sum[1:7])
frequency_pct <- c()
for (r in 1:nrow(s_harassment_frequency)){
  p <- pct(s_harassment_frequency[r, 23], harassment_frequency_total)
  frequency_pct <- c(frequency_pct, p)
}
s_harassment_frequency$frequency_pct <- frequency_pct
s_harassment_frequency <- relocate(s_harassment_frequency, 
                                c(frequency_sum, frequency_pct), 
                                .after = frequency)
# remove NA row
s_harassment_frequency <- s_harassment_frequency[-8,]
write.csv(s_harassment_frequency, "wos/harassment_frequency.csv")

# plot basic summary
p_harassment_frequency <- plot_factor_ordered(s_harassment_frequency,
                                                  "frequency",
                                                  "frequency_pct",
                                                  "Frequency of each harassment type",
                                                  "Percentage")
p_harassment_frequency
ggsave(filename = "harassment_frequency.png",
       path = "wos",
       plot = p_harassment_frequency)

# pivot for stacked bar plot
p_harassment_freq_data <- pivot_longer(s_harassment_frequency, 
                                         all_of(harassment_names), 
                                         names_to = "harassment_type",
                                         values_to = "count")
p_harassment_freq_data <- p_harassment_freq_data[-c(2:3)]
p_harassment_freq_data$frequency <- as_factor(p_harassment_freq_data$frequency)
p_harassment_freq_data$harassment_type <- as_factor(p_harassment_freq_data$harassment_type)
hf_palette <- c("#560B06", 
                "#6A2B27", 
                "#7E4C49",
                "#926D6A", 
                "#A68D8B",
                "#BAAEAD",
                "#CECECE")
# plot
p_harassment_freq <- ggplot(p_harassment_freq_data,
                              aes(fill = fct_rev(frequency),
                                  x = fct_rev(harassment_type),
                                  y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Harassment type") +
  ylab("Number of respondents") +
  theme(legend.title= element_blank()) +
  scale_fill_manual(values = hf_palette)

ggsave("wos/harassment_freq_stacked.png")
```
```{r harassment_freq_output, include = TRUE}
p_harassment_freq
```

## Associations between harassment and other variables

#### Harassment intensity scores
To gauge each respondent's overall level of harassment, we created a composite "harassment intensity" score that assigned a point for each separate kind of harassment, multiplied by the middle range of each frequency category. For instance, someone who said they had received personal insults would receive one point; if they said it had been twice, it would be 2 points; if they said 3-5 times, it would be 4 points (the middle of the 3-5 range). If they said they had also had death threats twice, that would give an additional two points, for a total score of 6. 

Because these scores are based on the simple harassment scores described above, the same numbers apply: Out of 510 respondents, 315 (61.8%) have harassment intensity scores of zero, and 195 (38.2%) have scores of at least one. Those participants who reported multiple categories of harassment at very high frequencies have scores in the hundreds.
```{r harassment_intensity}
harassment_freq <- as_tibble(wos$response_ID)
# create percentage column names
harassment_freq_names <- str_c(harassment_types, "frequency", sep = "_")
# zip names for count and percentage columns together
har_and_freq_names <- c()
for (i in seq_along(harassment_types)) {
  har_and_freq_names <- c(har_and_freq_names, 
                          harassment_types[i], 
                          harassment_freq_names[i])
}
# get list of column indices for main harassment questions
c_har_and_freq <- c()
for (i in har_and_freq_names) {
  search_phrase <- str_c("^", i, "$", sep = "")
  c_index <- grep(search_phrase, colnames(wos))
  c_har_and_freq <- c(c_har_and_freq, c_index)
}
# add each harassment column to dataframe
for (i in c_har_and_freq) {
  harassment_freq <- cbind(harassment_freq, wos[i])
}
# change NA cells to string "Blank"
# needed later in script to create harassment composite score
harassment_freq <- lapply(harassment_freq, as.character)
harassment_freq <- as.data.frame(map(harassment_freq, replace_na, "Blank"))
harassment_freq_levels <- c(hq4_factor_levels, "Blank")
harassment_freq_cols <- 2:ncol(harassment_freq)
# change all columns to factor levels, including "blank"
even_cols <- seq(2, 42, 2)
odd_cols <- seq(3, 43, 2)
for (i in odd_cols) {
  harassment_freq[[i]] <- factor(harassment_freq[[i]],
                                 levels = harassment_freq_levels)
}
for (i in even_cols) {
  harassment_freq[[i]] <- factor(harassment_freq[[i]],
                                 levels = harassment_factor_levels)
}
# check
str(harassment_freq)

harassment_intensity <- c()
even_cols <- seq(2, 42, 2)
# for each row in harassment dataframe
for (r in 1:nrow(harassment_freq)) {
  # open the harassment count for that participant
  k = 0
  # for each type of harassment
  for (i in even_cols) {
    m = 0
    # if the participant said yes, add a point to their score
    if (harassment_freq[r, i] == "Yes") {
      m = 1
    } else {
      m = 0
    }
    if (harassment_freq[r, i+1] == "Twice") {
      m = m*2
    } else if (harassment_freq[r, i+1] == "3-5 times") {
      m = m*4
    } else if (harassment_freq[r, i+1] == "6-10 times") {
      m = m*8
    } else if (harassment_freq[r, i+1] == "11-20 times") {
      m = m*15.5
    } else if (harassment_freq[r, i+1] == "21-50 times") {
      m = m*35.5
    } else if (harassment_freq[r, i+1] == ">50 times") {
      m = m*50
    }
    k = k + m
  }
  # add the participant's score to the vector
  harassment_intensity <- c(harassment_intensity, k)
}
harassment_intensity
# add the vector to harassment and wos dataframes
harassment_freq$harassment_intensity <- harassment_intensity
wos$harassment_intensity <- harassment_intensity
# write to csv
write.csv(harassment_freq, "wos/harassment_intensity.csv")
# distribution of harassment intensity scores
p_harassment_intensity <- ggplot(harassment_freq, aes(x=harassment_intensity)) +
  geom_histogram(binwidth = 1, color="#6D120B") +
  theme_minimal() +
  xlab("Harassment intensity score") +
  ylab("Number of participants") +
  theme(aspect.ratio=10/10)

ggsave(filename = "harassment_intensity.png",
       path = "wos",
       plot = p_harassment_intensity)
```
```{r harassment_intensity_output, include = TRUE}
p_harassment_intensity
```

#### Harassment by public attention
We calculated the association between harassment intensity and exposure intensity using Spearman's rank correlation. There was a positive association between the variables, *r* = 0.56, 95% CI [0.50 , 0.62]. This is classified as a "large" effect size, but it is crucial to note that there could be different explanations for this relationship: For instance, publicity may lead directly to more harassment, but scientists with greater prominence may receive both more harassment and more interview invitations. 
```{r harassment_publicity}
media_intensity_x_harassment_intensity <- 
  SpearmanRho(wos$media_intensity_score, 
            wos$harassment_intensity,
            conf.level = 0.95)
media_intensity_x_harassment_intensity

# subsetted dataframe with just media and harassment intensity scores
media_x_harassment <- data.frame(wos$response_ID, 
                                 wos$media_intensity_score, 
                                 wos$harassment_intensity)
write.csv(media_x_harassment, "wos/media_x_harassment.csv")

# plot
p_media_x_harassment <- ggplot(wos, aes(x=media_intensity_score, 
                y=harassment_intensity)) + geom_point() +
  geom_smooth(method=lm, color="#6D120B") +
  xlab("Exposure intensity score") +
  ylab("Harassment intensity score") +
  theme_minimal()

ggsave("wos/media intensity x harassment intensity.png")
```
```{r harassment_publicity_output, include = TRUE}
p_media_x_harassment
```

#### Harassment by publicity topic
We calculated the association between each publicity topic and harassment intensity using point-biserial correlations. Here we report the correlation coefficient and 95% CI for each topic. As with any correlation, there could be multiple explanations for the appearance of a relationship. Fewer than 20 respondents reported advocating for some topics (not locking down, not restricting travel, not wearing masks, and other topics further down in the table), meaning that these results should be interpreted with extra caution. 
```{r harassment_topictopic}
# empty list
topic_harassment <- NULL
# loop through publicity topic column indices
for (i in c_publicity_topic) {
  # get harassment intensity scores where participant
  # reported advocating for that topic
  s <- subset(wos$harassment_intensity, wos[i] == TRUE)
  # get summary stats for those harassment intensity scores  
  r <- subject_summary(s)
  # add summary stats to list
  topic_harassment <- cbind(topic_harassment, r)
}
# convert to data frame and set column & row names
topic_harassment <- as.data.frame(topic_harassment)
topic_names <- c("Wearing masks",
                 "Not wearing masks",
                 "Vaccination",
                 "Refusing vaccination",
                 "Not vaccinating certain groups (e.g. children)",
                 "Vaccine passports or mandates",
                 "Hand-washing and hygiene",
                 "Ventilation",
                 "Travel restrictions",
                 "Not restricting travel",
                 "Treating with hydroxychloroquine",
                 "Not treating with hydroxychloroquine",
                 "Treating with ivermectin",
                 "Not treating with ivermectin",
                 "Lockdown",
                 "Not locking down",
                 "Natural origin of the virus being most likely",
                 "Lab origin of the virus being most likely")
colnames(topic_harassment) <- topic_names
rownames(topic_harassment) <- c("No. of participants",
                                  "Min",
                                  "1st. Qu.",
                                  "Median",
                                  "Mean",
                                  "3rd Qu.",
                                  "Max", 
                                  "Sum")
write.csv(topic_harassment, "wos/topic_harassment.csv")

# get correlations between publicity topic and harassment
# get indices of publicity topic columns
topic_cols <- 135:152
topic_correlations <- data.frame()
# run correlation for each column and add results to dataframe
for (i in topic_cols) {
  coef <- cor.test(as.numeric(wos[[i]]),
      wos$harassment_intensity)
  r <- c(coef$conf.int[1], coef$estimate[[1]], coef$conf.int[2])
  topic_correlations <- rbind(topic_correlations, r)
}
rownames(topic_correlations) <- topic_names
colnames(topic_correlations) <- c("Lower 95% CI",
                                  "Point-Biserial", 
                                  "Upper 95% CI")
topic_correlations <- arrange(topic_correlations, desc(`Point-Biserial`))
write.csv(topic_correlations, "wos/topic_correlations.csv")

# pivot data for facet_wrap plots
t_publicity_topics <- tibble(wos[c_publicity_topic])
colnames(t_publicity_topics) <- o_publicity_topic[,2]
t_publicity_topics$harassment_intensity <- wos$harassment_intensity
c_publicity_topic_names <- colnames(wos[c_publicity_topic])
pt_data <- pivot_longer(t_publicity_topics, 
                        all_of(o_publicity_topic[,2]), 
                               names_to = "topic",
                               values_to = "response")
# scatterplot for each publicity topic
p_publicity_topic_harassment <- ggplot(pt_data, aes(x=response,
                y=harassment_intensity)) + geom_point() +
  scale_x_discrete(labels=c("Did not support", "Supported")) +
  facet_wrap(~topic)
p_publicity_topic_harassment
ggsave("wos/publicity_topic_scatterplots.png")
```
```{r harassment_topic_output, include = TRUE}
kable(topic_correlations)
```

## Section 3: Effects, protection, and institutional support
Only participants who reported at least one category of harassment (n = 195) were asked questions in this section. Participants who reported no harassment moved directly to demographic questions.

#### Before the COVID-19 pandemic, had you ever experienced unwanted behaviors, harassment, bullying, intimidation, stalking, or threats as a result of your work?
```{r prepandemic_harassment}
# check factor levels
count(wos, prepandemic_harassment)
factor_levels <- c("Never before the COVID-19 pandemic",
                   "Much less than I've experienced during the COVID-19 pandemic",
                   "Somewhat less than I've experienced during the COVID-19 pandemic",
                   "The same as I've experienced during the COVID-19 pandemic",
                   "Somewhat more than I've experienced during the COVID-19 pandemic",
                   "Much more than I've experienced during the COVID-19 pandemic")
# percentage column is for whole sample, not subset who reported harassment
s_prepandemic_harassment <- summary_factor_ordered(wos, 
                                                   "prepandemic_harassment", 
                                                   factor_levels)
# plot
p_prepandemic_harassment <- plot_factor_ordered(s_prepandemic_harassment,
                                              "prepandemic_harassment",
                                              "n",
                                              "How much harassment before the pandmic?",
                                              "Number of respondents")
ggsave(filename = "prepandemic_harassment.png",
       path = "wos",
       plot = p_prepandemic_harassment)
```
```{r prepandemic_harassment_output, include = TRUE}
p_prepandemic_harassment
```

#### How has harassment or intimidation as a result of your COVID-19 research affected you?
```{r effects}
# get column indices
c_effects <- column_chunk(wos, "effects_")
# one column from another question caught in the net; remove
c_effects <- c_effects[- 1]
# get multiple choice options
o_effects <- get_multiple_choice(wos, "effects", 
                                   c_effects)
effects_headings <- o_effects[[2]]
# create factor level list
effects_factor_levels <- c("Not at all", 
                       "A little", 
                       "Somewhat", 
                       "A lot", 
                       "Extremely", 
                       "Prefer not to say")
# change factor levels in each column
for (i in c_effects) {
  wos[[i]] <- factor(wos[[i]], 
                     levels = effects_factor_levels)
}
# recheck factor levels
for (i in c_effects) {
  print(count(wos, wos[i]))
}
# create empty dataframe for summary results
s_effects <- c()
# set frequency levels as column 1
s_effects <- cbind(s_effects, (effects_factor_levels))
# for each survey question, generate summary results,
# remove NA from end of list,
# calculate percentage for each frequency level
# add both count and percentage columns into results dataframe
for (i in c_effects) {
  results <- count(wos, wos[i], .drop = FALSE)
  results <- results[-7,]
  results_pct <- c()
  for (i in results[,2]) {
    p <- pct(i, sum(results[,2]))
    results_pct <- c(results_pct, p)
  }
  s_effects <- cbind(s_effects, results[2], results_pct)
}
# create percentage column names
pct_col_names <- str_c(effects_headings, "(%)", sep = " ")
# zip names for count and percentage columns together
var_names <- c()
for (i in seq_along(effects_headings)) {
  var_names <- c(var_names, effects_headings[i], pct_col_names[i])
}
# set column names
col_names <- c("Frequency", var_names)
colnames(s_effects) <- col_names
# write to csv
write_csv(as_tibble(s_effects), "wos/effects.csv")

# pivot for stacked bar plot
p_effects_data <- pivot_longer(s_effects, 
                                       all_of(effects_headings), 
                                       names_to = "effects",
                                       values_to = "count")
p_effects_data <- p_effects_data[-c(2:16)]
p_effects_data$Frequency <- factor(p_effects_data$Frequency,
                                      levels = c("Extremely",
                                      "A lot",
                                      "Somewhat",
                                      "A little",
                                      "Not at all",
                                      "Prefer not to say"))
p_effects_data$effects <- as_factor(p_effects_data$effects)
# plot
p_effects <- ggplot(p_effects_data,
                            aes(fill = Frequency,
                                x = fct_rev(effects),
                                y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Effects") +
  ylab("Number of respondents") +
  theme(legend.title= element_blank()) +
  scale_fill_manual(values = ht_palette)

ggsave("wos/effects.png")
```
```{r effects_output, include = TRUE}
p_effects
```

#### What measures have you taken to protect yourself from harassment and/or intimidation? (Select all that apply.)
```{r protective_measures}
# export summaries of free text responses
summary_free_text(wos, "protective_measures_free_text")
# get column indices for question
c_protective_measures <- column_chunk(wos, "protective_measures_")
# check whether last item in printout is a free text field
# if it is, remove final index
c_protective_measures <- head(c_protective_measures, -1)
# get multiple choice options
o_protective_measures <- get_multiple_choice(wos, "protective_measures_", 
                                             c_protective_measures)
# generate output dataset
s_protective_measures <- summary_logic_set(wos, 
                                           c_protective_measures, 
                                           o_protective_measures[,2], 
                                           "protective_measures")
# plot
p_protective_measures <- plot_factor_unordered(s_protective_measures, 
                                            "protective_measures",
                                            "count_yes", 
                                            "Protective measures", 
                                            "Number of respondents")

ggsave(filename = "protective_measures.png",
       path = "wos",
       plot = p_protective_measures)
```
```{r protective_measures_output, include = TRUE}
p_protective_measures
```

```{r employer_support_individual}
count(wos, employer_legal_support)
factor_levels <- c("Yes",
                   "No",
                   "Not applicable - did not need or request")
s_employer_legal_support <- summary_factor_ordered(wos, 
                                                      "employer_legal_support", 
                                                      factor_levels)
s_employer_security_support <- summary_factor_ordered(wos, 
                                                   "employer_security_support", 
                                                   factor_levels)
s_employer_technological_support <- summary_factor_ordered(wos, 
                                                   "employer_technological_support", 
                                                   factor_levels)
s_employer_mental_health_support <- summary_factor_ordered(wos, 
                                                   "employer_mental_health_support", 
                                                   factor_levels)

count(wos, employer_legal_support_satisfaction)
factor_levels <- c("Extremely dissatisfied",
                   "Dissatisfied",
                   "Neutral",
                   "Satisfied",
                   "Extremely satisfied")
s_employer_legal_support_satisfaction <- summary_factor_ordered(wos, 
                                                      "employer_legal_support_satisfaction", 
                                                      factor_levels)
s_employer_security_support_satisfaction <- summary_factor_ordered(wos, 
                                                                "employer_security_support_satisfaction", 
                                                                factor_levels)
s_employer_technological_support_satisfaction <- summary_factor_ordered(wos, 
                                                                "employer_technological_support_satisfaction", 
                                                                factor_levels)
s_employer_mental_health_support_satisfaction <- summary_factor_ordered(wos, 
                                                                "employer_mental_health_support_satisfaction", 
                                                                factor_levels)
```

#### Did you receive any of the following kinds of support from your employers?
Participants were asked four separate questions, one for each kind of support. If they said they had received a particular kind of support, they were then asked about their level of satisfaction with that support.

Very low numbers reported receiving support; however, of those who did receive support, the majority said they were satisfied or extremely satisfied with the help they received. 
```{r employer_support_summary}
s_employer_support <- data.frame(s_employer_legal_support$employer_legal_support,
                                 s_employer_legal_support$n,
                                 s_employer_security_support$n,
                                 s_employer_technological_support$n,
                                 s_employer_mental_health_support$n)
colnames(s_employer_support) <- c("response", "Legal",
                                  "Security", "Technological",
                                  "Mental health")
s_employer_support$sum <- c(sum(s_employer_support[1,2:5]),
                            sum(s_employer_support[2,2:5]),
                            sum(s_employer_support[3,2:5]))
s_employer_support <- relocate(s_employer_support, 
                                   sum, 
                                   .after = response)
write.csv(s_employer_support, "wos/employer_support.csv")

# pivot for stacked bar plot
p_employer_support_data <- pivot_longer(s_employer_support, 
                               c("Legal",
                                 "Security",
                                 "Technological",
                                 "Mental health"), 
                               names_to = "support",
                               values_to = "count")
p_employer_support_data <- p_employer_support_data[-2]
p_employer_support_data$response <- as_factor(p_employer_support_data$response)
p_employer_support_data$support <- as_factor(p_employer_support_data$support)
# plot
p_employer_support <- ggplot(p_employer_support_data,
                    aes(fill = response,
                        x = support,
                        y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Support") +
  ylab("Number of respondents") +
  theme(legend.title= element_blank()) +
  scale_fill_manual (values = c("#560B06", "#926D6A", "#CECECE"))
ggsave("wos/employer_support.png")
```
```{r employer_support_summary_output, include = TRUE}
p_employer_support
```

#### How satisfied were you with any such report received?
```{r employer_support_satisfaction}
s_employer_support_satisfaction <- data.frame(s_employer_legal_support_satisfaction$employer_legal_support_satisfaction,
                                 s_employer_legal_support_satisfaction$n,
                                 s_employer_security_support_satisfaction$n,
                                 s_employer_technological_support_satisfaction$n,
                                 s_employer_mental_health_support_satisfaction$n)
colnames(s_employer_support_satisfaction) <- c("satisfaction", "Legal",
                                  "Security", "Technological",
                                  "Mental health")
s_employer_support_satisfaction$sum <- c(sum(s_employer_support_satisfaction[1,2:5]),
                              sum(s_employer_support_satisfaction[2,2:5]),
                              sum(s_employer_support_satisfaction[3,2:5]),
                              sum(s_employer_support_satisfaction[4,2:5]),
                              sum(s_employer_support_satisfaction[5,2:5]))
s_employer_support_satisfaction <- relocate(s_employer_support_satisfaction, 
                               sum, 
                               .after = satisfaction)
write.csv(s_employer_support_satisfaction, "wos/employer_support_satisfaction.csv")

# pivot for stacked bar plot
p_employer_support_satisfaction_data <- pivot_longer(s_employer_support_satisfaction, 
                                        c("Legal",
                                          "Security",
                                          "Technological",
                                          "Mental health"), 
                                        names_to = "support",
                                        values_to = "count")
p_employer_support_satisfaction_data <- p_employer_support_satisfaction_data[-2]
p_employer_support_satisfaction_data$satisfaction <- as_factor(p_employer_support_satisfaction_data$satisfaction)
p_employer_support_satisfaction_data$support <- as_factor(p_employer_support_satisfaction_data$support)
# plot
p_employer_support_satisfaction <- ggplot(p_employer_support_satisfaction_data,
                             aes(fill = fct_rev(satisfaction),
                                 x = support,
                                 y = count)) +
  geom_bar(position = position_stack(reverse = TRUE), stat="identity") +
  coord_flip() +
  theme_minimal() +
  theme(aspect.ratio=15/10) +
  xlab("Support") +
  ylab("Number of respondents") +
  theme(legend.title= element_blank()) +
  scale_fill_manual (values = c("#560B06", "#743C38", "#926D6A", "#B09D9C", "#CECECE"))

ggsave("wos/employer_support_satisfaction.png")
```
```{r employer_support_satisfaction_output, include = TRUE}
p_employer_support_satisfaction
```

#### If you received any other kind of support from your employers, please tell us what kind of support you received:
Free text responses included mentions of emotional support, including institutions making it clear that a researcher's public engagement activity was valuable. But many other responses noted that no support of any kind had been available, and some included mention of universities instructing respondents to stop speaking publicly.
```{r other_employer_support}
summary_free_text(wos, "other_employer_support")
```

#### Is there any other kind of support, from your employers or from anyone else, you would have liked but did not have access to?
Many respondents indicated that they wanted emotional support from employers: recognition that their public engagement work is valuable, and enquiries regarding wellbeing. 
```{r wished_for_support}
summary_free_text(wos, "wished_for_support")
```

#### Is there anything else you would like to tell us about your experience of intimidation and/or harassment?
Some responses noted that abuse had come from other academics, or noted other topics that had resulted in harassment, including vaccine side effects, ME/CFS, and the pandemic's intersecton with racial inequality. One respondent noted that their institution had refused to delist contact details on the university website. Another noted that a supportive PhD advisor had greatly increased their feelings of safety. 
```{r harassment_free_text}
summary_free_text(wos, "harassment_free_text")
```

#### Are there any other questions you think we should have asked?
One respondent noted that witnessing other researchers' experiences of abuse had made them less likely to participate in public communication. Another noted that they had ended a vaccine information project on Facebook due to abuse. And one noted that they intended to leave the field due to the abuse they had experienced. 
```{r other_questions_free_text}
summary_free_text(wos, "other_questions_free_text")
```

## Section 4: Demographics

#### How old are you?
```{r age}
count(wos, age)
factor_levels <- c("18 to 24",
                   "25 to 34",
                   "35 to 44",
                   "45 to 54",
                   "55 to 64",
                   "65 to 74",
                   "75 or older",
                   "Decline to answer")
s_age <- summary_factor_ordered(wos, "age", factor_levels)
p_age <- plot_factor_ordered(s_age,
                              "age",
                              "n",
                              "Age",
                              "Number of respondents")
ggsave(filename = "age.png",
       path = "wos",
       plot = p_age)

```
```{r age_output, include = TRUE}
p_age
```

#### In what country or countries did you grow up? (Until the age of 18)
```{r countries_grew_up}
# get column indices for question
c_countries_grew_up <- column_chunk(wos, "countries_grew_up_")
# get multiple choice options
o_countries_grew_up <- get_multiple_choice(wos, "countries_grew_up_", 
                                             c_countries_grew_up)
# format multiple choice options for summary table and plot
o_countries_grew_up[,2] <- str_to_title(o_countries_grew_up[,2])
# generate output dataset
s_countries_grew_up <- summary_logic_set(wos, 
                                           c_countries_grew_up, 
                                         o_countries_grew_up[,2], 
                                           "countries_grew_up")
p_countries_grew_up <- plot_factor_unordered(s_countries_grew_up, 
                                               "countries_grew_up",
                                               "count_yes", 
                                               "", 
                                               "Number of respondents")
ggsave(filename = "countries_grew_up.png",
       path = "wos",
       plot = p_countries_grew_up)
```
```{r countries_grew_up_output, include = TRUE, fig.dim = c(12, 10), out.width = "100%"}
p_countries_grew_up
```

#### What sector do you work in?
```{r sector}
s_sector <- summary_factor_no_na_unordered(wos, "sector")
summary_free_text(wos, "sector_free_text")
p_sector <- plot_factor_unordered(s_sector, 
                                  "sector",
                                  "n", 
                                  "Sector", 
                                  "Number of respondents")
ggsave(filename = "sector.png",
       path = "wos",
       plot = p_sector)
```
```{r sector_output, include = TRUE}
p_sector
```

#### What is your current career stage?
```{r career_stage}
count(wos, career_stage)
factor_levels <- c("Student - masters",
                   "Student - PhD/MD (including doctoral students on employee contracts)",
                   "Professional - less than five years' experience",
                   "Professional - 6-15 years' experience",
                   "Professional - more than 15 years' experience",
                   "Retired",
                   "Decline to answer",
                   "Other - please describe:")
s_career_stage <- summary_factor_ordered(wos, "career_stage", factor_levels)
summary_free_text(wos, "career_stage_free_text")
p_career_stage <- plot_factor_ordered(s_career_stage,
                             "career_stage",
                             "n",
                             "Career stage",
                             "Number of respondents")
ggsave(filename = "career_stage.png",
       path = "wos",
       plot = p_career_stage)
```
```{r career_stage_output, include = TRUE}
p_career_stage
```

#### Do you have a long-standing physical or mental impairment, illness, or disability? (Anything that has affected you, or is likely to affect you, for at least a year):
```{r disability}
count(wos, disability)
yes_no_factor_levels <- c("Yes",
                          "No",
                          "Decline to answer")
s_disability <- summary_factor_ordered(wos, "disability", yes_no_factor_levels)
p_disability <- plot_factor_ordered(s_disability,
                                      "disability",
                                      "n",
                                      "Disability",
                                      "Number of respondents")
ggsave(filename = "disability.png",
       path = "wos",
       plot = p_disability)
```
```{r disability_output, include = TRUE}
p_disability
```

#### What is your ethnic/racial/caste/cultural identity? Please use any term that you feel describes you accurately.
In order to avoid excluding any particular group, this was offered as a free text response. Given the responses to the following questions indicating that the survey population was predominantly ethnic majority/other groups who do not experience prejudice, these results were not analyzed.
```{r ethnicity}
summary_free_text(wos, "ethnicity")
```

#### In the place where you work, are you in the ethnic/racial/caste/cultural majority or minority?:
This question was intended to capture a global range of minority identities. 
```{r minority}
count(wos, minority)
factor_levels <- c("In the ethnic/racial/caste/cultural majority",
                   "In the ethnic/racial/caste/cultural minority",
                   "Not sure",
                   "Decline to answer")
s_minority <- summary_factor_ordered(wos, "minority", factor_levels)
p_minority <- plot_factor_ordered(s_minority,
                                    "minority",
                                    "n",
                                    "At work, are you in the ethnic/racial/caste/cultural majority?",
                                    "Number of respondents")
ggsave(filename = "minority.png",
       path = "wos",
       plot = p_minority)
```
```{r minority_output, include = TRUE}
p_minority
```

#### In the place where you work, does your ethnic group/race/caste/culture face systemic racism, prejudice, or other disadvantage?
In some countries, an ethnic majority may still experience systemic disadvantage (for example, Black people in South Africa). This question was designed to separate the experience of systemic disadvantage from the question of majority/minority status. 
```{r prejudice}
count(wos, prejudice)
factor_levels <- c("Yes",
                   "No",
                   "Not sure",
                   "Decline to answer")
s_prejudice <- summary_factor_ordered(wos, "prejudice", factor_levels)
p_prejudice <- plot_factor_ordered(s_prejudice,
                                  "prejudice",
                                  "n",
                                  "At work, do you face systemic prejudice?",
                                  "Number of respondents")
ggsave(filename = "prejudice.png",
       path = "wos",
       plot = p_prejudice)
```
```{r prejudice_output, include = TRUE}
p_prejudice
```

#### What is your sexual orientation?
```{r sexual_orientation}
count(wos, sexual_orientation)
factor_levels <- c("Asexual",
                   "Bisexual",
                   "Gay",
                   "Lesbian",
                   "Pansexual",
                   "Straight",
                   "Self-identify (please describe):",
                   "Decline to answer")
s_sexual_orientation <- summary_factor_ordered(wos, "sexual_orientation", factor_levels)
summary_free_text(wos, "sexual_orientation_free_text")
p_sexual_orientation <- plot_factor_ordered(s_sexual_orientation,
                                   "sexual_orientation",
                                   "n",
                                   "Sexual orientation",
                                   "Number of respondents")
ggsave(filename = "sexual_orientation.png",
       path = "wos",
       plot = p_sexual_orientation)

```
```{r sexual_orientation_output, include = TRUE}
p_sexual_orientation
```

#### What is your gender identity?
```{r gender}
count(wos, gender)
factor_levels <- c("Man",
                   "Nonbinary",
                   "Woman",
                   "Self-identify (please describe):",
                   "Decline to answer")
s_gender <- summary_factor_ordered(wos, "gender", factor_levels)
# summary_free_text(wos, "gender_free_text") #aaas only
p_gender <- plot_factor_ordered(s_gender,
                                            "gender",
                                            "n",
                                            "Gender",
                                            "Number of respondents")

ggsave(filename = "gender.png",
       path = "wos",
       plot = p_gender)
```
```{r gender_output, include = TRUE}
p_gender
```

#### Are you transgender?
```{r transgender}
count(wos, transgender)
factor_levels <- c("No",
                   "Decline to answer")
s_transgender <- summary_factor_ordered(wos, "transgender", factor_levels)
p_transgender <- plot_factor_ordered(s_transgender,
                                "transgender",
                                "n",
                                "Are you transgender?",
                                "Number of respondents")
ggsave(filename = "transgender.png",
       path = "wos",
       plot = p_transgender)
```
```{r transgender_output, include = TRUE}
p_transgender
```

#### Do you experience, or have you experienced, discrimination based on your identity? If so, please feel free to give details:
Many free text responses noted the effects of sexism in science. Others noted ageism, religious discrimination, and racism. 
```{r discrimination_free_text}
summary_free_text(wos, "discrimination_free_text")
```

#### Harassment by demographics
No associations were found between demographics and harassment. However, these results should be interpreted with extreme caution. As is clear from the demographic analyses above, there were very few racial, cultural, or sexual minorities in the survey sample, meaning that any real effect may not have been detectable in this sample. There may also be multiple explanations for a lack of association: For instance, people who feel particularly at risk of abuse may self-select out of public attention at a higher rate, and thereby avoid more extreme harassment. 
```{r demographic_harassment}
# run correlation for demographic variables x harassment
# add results to dataframe
demog_names <- c("age", "sector", "career_stage", 
                "disability", "minority", "prejudice",
                "sexual_orientation", "gender")
demog_cols <- c()
for (i in demog_names) {
  search_phrase <- str_c("^", i, "$", sep = "")
  index <- grep(search_phrase, colnames(wos))
  demog_cols <- c(demog_cols, index)
}
demog_cols
demog_correlations <- data.frame()
for (i in demog_cols) {
  coef <- cor.test(as.numeric(wos[[i]]),
                      wos$harassment_intensity)
  r <- c(coef$conf.int[1], coef$estimate[[1]], coef$conf.int[2])
  demog_correlations <- rbind(demog_correlations, r)
}
rownames(demog_correlations) <- c("Age", "Sector", "Career stage", 
                "Disability", "Minority", "Prejudice",
                "Sexual orientation", "Gender")
colnames(demog_correlations) <- c("Lower 95% CI",
                                  "Point-Biserial", 
                                  "Upper 95% CI")
demog_correlations <- arrange(demog_correlations, desc(`Point-Biserial`))
write.csv(demog_correlations, "wos/demog_correlations.csv")
```
```{r demographic_harassment_output, include = TRUE}
kable(demog_correlations)
```

## Section 5: Charity selection

#### As thanks to everyone who participates in this survey, Science will donate $500 to charity, divided proportionally among three charities according to participants’ selections. The options are:
```{r charity_choice}
s_charity_choice <- summary_factor_no_na_unordered(wos, "charity_choice")
p_charity_choice <- plot_factor_unordered(s_charity_choice, 
                                  "charity_choice",
                                  "n", 
                                  "Charity choice", 
                                  "Number of respondents")

ggsave(filename = "charity_choice.png",
       path = "wos",
       plot = p_charity_choice)
```
```{r charity_choice_output, include = TRUE}
p_charity_choice
```

*Science* will donate:

* $193.75 to COVID-19 Solidarity Response Fund  

* $162.50 to GiveDirectly 

* $143.75 to Malaria Consortium       

With thanks to all participants. 


```{r export_datasets}
# export a copy of final dataset
write.csv(wos, "wos_processed.csv", row.names = FALSE)

### IRB procedure required the removal of potentially identifying
### before publishing the dataset, including location, demographics, 
### and career information.
### The content of these columns has been redacted, 
### rather than the columns removed, to aid in code-checking 
### and at least partial reproducibility of this script.

# create a vector of repeated strings
redacted <- rep("redacted", nrow(wos))
# new dataset with redacted columns
wos_redacted <- wos
# column name search phrases
redaction_names <- c("covid_papers_discipline",
                    "research_country",
                    "residence_country",
                    "publicity_countries",
                    "publicity_discipline",
                    "publicity_topic",
                    "other_employer_support",
                    "wished_for_support",
                    "age",
                    "countries_grew_up",
                    "sector", 
                    "career_stage", 
                    "disability", 
                    "ethnicity",
                    "minority", 
                    "prejudice",
                    "sexual_orientation", 
                    "gender",
                    "transgender",
                    "email_text")
# get column indices that begin with these search phrases
redaction_cols <- c()
for (i in redaction_names) {
  search_phrase <- str_c("^", i, sep = "")
  index <- grep(search_phrase, colnames(wos))
  redaction_cols <- c(redaction_cols, index)
}
redaction_cols
# redact the content of those columns
for (i in redaction_cols) {
  wos_redacted[i] <- redacted
}
# get column indices that end with "free_text"
free_text_cols <- grep(str_c("_free_text", "$", ""), colnames(wos))
free_text_cols
# redact the content of those columns
for (i in free_text_cols) {
  wos_redacted[i] <- redacted
}
write.csv(wos_redacted, "wos_anonymised.csv", row.names = FALSE)


#####
```



